---
layout: post
title: How to add thirdparty libraries to an ASF4 project.
categories: [howto, tutorial]
tags: [sam, start, atmel, microchip, arm, microcontrollers]
---

I had to add MQTT functionality to the TCP server demo from START examples.
I found that the mqtt chat example from ASF3 is not available yet on the START platform, so I had to manually add that library to the TCP server example
To achieve the task we must perform the following steps.

* Copy library files to the project.
* Update makefile with the new files routes.
* Resolve routes for include files on the added library.
* Integrate the library application code to the new application.
* Resolve variables or missing data.
* Enjoy.

I did this using Ubuntu 19.04

## Copy library files to the project.

In this case I required to add MQTT capabilities to the winc_tcp_server demo.
After download the START example and decomprese the folder structure looks like this:

![Original][Original_img]

I created a pahomqtt folder on root example folder.

![PahoFolder][PahoFolder_img]

Now from the ASF3 sdk I copied the pahomqtt folder contents and pasted on the folder that was just created.

This is how those files look after copied.
![PahoContents][PahoContents_img]

## Update makefile.

This is the trickier part, after the files were copied we need to tell the project that those files were added, so the Makefile need to be updated.
Makefile is located on the gcc folder.

[Makefile_location][Makefile_location_img]

The Makefile generated by the START tool seems messy, so before it is updated we do some manual clean. 
This is an example on the SUB_DIRS section on how the file looks.

![makefile_original][makefile_ori_img]

Arrange the lines at the SUB_DIRS, OBJS, OBJS_AS_ARGS, DIR_INCLUDES, DEPS_AS_ARGS sections based on files and folder
Add in each of the previous sections the paths and files required 
 * Every folder must appear
 * For each .c file a .o or .d file must appear.
 * include sections must reflect all folders that have a .h file.

SUB_DIRS section.
![sub_dirs][sub_dirs_img]

OBJ section.
![objs][objs_img]

OBJS_AS_ARGS section.
![objs_as_args][objs_as_args_img]

DIR_INCLUDES section.
![dir_includes][dir_includes_img]

DEP_AS_ARGS section.
![dep_as_args][dep_as_args_img]

## Resolve routes on includes.

The copied files were arranged on ASF3 fashion, so when imported some include paths will not be correct.
The way I fixed this is to run `make` on the gcc file and wait for the errors raised at compile, some of them will show that the file is unknown. So go there and fix those paths.

**Caution, only modify the includes starting with "MQTT".**

Files to modify:

    * pahomqtt/MQTTClient/MQTT_Client.h
    * pahomqtt/MQTTClient/Wrapper/mqtt.h

![includes_fix][includes_fix_img]20200203-includesFix.

On the mqtt.h file I had to add the <stdbool.h> since it is not include on the base example and is required for that file to work.

At this point compiling the code must complete correctly.

## Integrate the library application code to the new application.


[Original_img]:/images/20200203-original-folders.png
[PahoFolder_img]:/images/20200203-paho-create.png
[PahoContents_img]:/images/20200203-paho-contents.png
[Makefile_location_img]20200203-makefile-location.png
[makefile_ori_img]:/images/20200203-makefile-original.png
[sub_dirs_img]:/images/20200203_sub_dirs.png
[objs_img]:/images/20200203_objs.png
[objs_as_args_img]:/images/20200203_dep_as_args.png
[dir_includes_img]:/images/20200203_dir_includes.png
[includes_fix_img]:/images/20200203-includesFix
